/*
 * force-js - v0.1.0
 * built 2013-02-10
 * https://github.com/couchand/force-js
 * Copyright (c) 2013 Andrew Couch
 * Licensed MIT
 */
"use strict";function nicehttp(e,t,n,r,i){var s="",o=new promise.Deferred,u={method:e,host:t,path:n,headers:r},a=https.request(u,function(e){e.setEncoding("utf8"),e.on("data",function(e){s+=e}),e.on("end",function(){o.resolve(s)})});return a.on("error",function(e){o.reject(e)}),i&&a.write(i),a.end(),o}function myget(e,t,n){return nicehttp("GET",e,t,n)}function mypost(e,t,n,r){return nicehttp("POST",e,t,n,r)}function mypatch(e,t,n,r){return nicehttp("PATCH",e,t,n,r)}function mydelete(e,t,n){return nicehttp("DELETE",e,t,n)}function jsonget(e,t,n){return myget(e,t,{Authorization:"Bearer "+n}).then(function(e){return JSON.parse(e)})}function jsondelete(e,t,n){return mydelete(e,t,{Authorization:"Bearer "+n})}function querypost(e,t,n){var r=querystring.stringify(n);return mypost(e,t,{"Content-Type":"application/x-www-form-urlencoded","Content-Length":r.length},r)}function jsonpost(e,t,n,r){var i=r?JSON.stringify(r):!1;return mypost(e,t,{"Content-Type":"application/json","Content-Length":i.length,Authorization:"Bearer "+n},i).then(function(e){return JSON.parse(e)})}function jsonpatch(e,t,n,r){var i=r?JSON.stringify(r):!1;return mypatch(e,t,{"Content-Type":"application/json","Content-Length":i.length,Authorization:"Bearer "+n},i).then(function(e){return e})}var https=require("https"),querystring=require("querystring"),promise=require("node-promise"),RecursiveResource=function(t,n){this.recursive_resource_name=t,this.proxied=n};RecursiveResource.prototype.get=function(e){return this.proxied.get("/"+this.recursive_resource_name+e)},RecursiveResource.prototype.post=function(e,t){return this.proxied.post("/"+this.recursive_resource_name+e,t)},RecursiveResource.prototype.patch=function(e,t){return this.proxied.patch("/"+this.recursive_resource_name+e,t)},RecursiveResource.prototype.delet=function(e){return this.proxied.delet("/"+this.recursive_resource_name+e)};var Tooling=function(t){this.proxied=t};Tooling.prototype=new RecursiveResource("tooling"),Tooling.prototype.pollForDeployment=function(e,t){var n=this;this.getSObject("containerasyncrequest",e).then(function(r){r.State==="Queued"?(t.progress("Deployment "+r.Id+" still queued."),n.pollForDeployment(e,t)):"Completed"===r.State?t.resolve(r):t.reject(r)})},Tooling.prototype.deploy=function(e,t){var n=this,r=new promise.Deferred;return this.insert("ContainerAsyncRequest",{MetadataContainerId:e,IsCheckOnly:t}).then(function(e){r.progress("Deployment Id: "+e),n.pollForDeployment(e,r)}),r};var Connection=exports.Connection=function(e,t,n,r){this.login_url=e,this.resource_url=t,this.client_id=n,this.client_secret=r,this.api_version="v26.0",this.base_path="/services/data/";var i=this;this.listVersions().then(function(e){e&&e.length&&e[e.length-1]&&(i.api_version="v"+e[e.length-1].version)}),this.chatter=new RecursiveResource("chatter",this),this.connect=new RecursiveResource("connect",this),this.tooling=new Tooling(this)};Connection.prototype.authorize=function(e,t,n){var r=this,i=new promise.Deferred;return querypost(this.login_url,"/services/oauth2/token",{grant_type:"password",client_id:this.client_id,client_secret:this.client_secret,username:e,password:t+n}).then(function(e){if(e){var t=JSON.parse(e);return t.access_token?(r.access_token=t.access_token,i.resolve(t)):t.error_description?i.reject(t.error_description):t.error?i.reject(t.error):i.reject(t)}return i.reject(e)}),i},exports.connect=function(e){var t=new Connection(e.login_url,e.resource_url,e.client_key,e.client_secret);return t.authorize(e.username,e.password,e.token).then(function(){return t})},Connection.prototype.get=function(e){return jsonget(this.resource_url,this.base_path+this.api_version+e,this.access_token)},Connection.prototype.post=function(e,t){return jsonpost(this.resource_url,this.base_path+this.api_version+e,this.access_token,t)},Connection.prototype.patch=function(e,t){return jsonpatch(this.resource_url,this.base_path+this.api_version+e,this.access_token,t)},Connection.prototype.delet=function(e){return jsondelete(this.resource_url,this.base_path+this.api_version+e,this.access_token)},Connection.prototype.listVersions=function(){return jsonget(this.resource_url,this.base_path)},RecursiveResource.prototype.listResources=Connection.prototype.listResources=function(){return this.get("/")},Connection.prototype.listRecent=function(){return this.get("/recent")},Tooling.prototype.listSObjects=Connection.prototype.listSObjects=function(){return this.get("/sobjects").then(function(e){return e.sobjects})},Tooling.prototype.getSObject=Connection.prototype.getSObject=function(e,t){return this.get("/sobjects/"+e+"/"+t)},Connection.prototype.search=function(e){return this.get("/search?q="+querystring.escape(e))},Tooling.prototype.query=Connection.prototype.query=function(e){var t="/query?q="+querystring.escape(e);return this.get(t).then(function(e){return e.records})},Tooling.prototype.insert=Connection.prototype.insert=function(e,t){var n="/sobjects/"+e;return this.post(n,t).then(function(e){return e.id})},Tooling.prototype.update=Connection.prototype.update=function(e,t,n){var r="/sobjects/"+e+"/"+t;return this.patch(r,n)},Tooling.prototype.destroy=Connection.prototype.destroy=function(e,t){var n="/sobjects/"+e+"/"+t;return this.delet(n)},Tooling.prototype.describe=Connection.prototype.describe=function(e){var t="/sobjects/"+e+"/describe";return this.get(t)},Connection.prototype.pollForResults=function(e,t){var n=this;this.query("SELECT Id, Status FROM ApexTestQueueItem WHERE Id = '"+e+"'").then(function(r){r[0].Status!=="Aborted"&&r[0].Status!=="Completed"&&r[0].Status!=="Failed"?n.pollForResults(e,t):n.query("SELECT Id, Outcome, Message, StackTrace, ApexClass.Name, MethodName FROM ApexTestResult WHERE QueueItemId = '"+e+"'").then(t)})},Connection.prototype.testId=function(e){var t=this,n=new promise.Deferred;return this.insert("ApexTestQueueItem",{ApexClassId:e}).then(function(e){t.pollForResults(e,function(e){n.resolve(e)})}),n},Connection.prototype.test=function(e){var t=this;return this.query("select id, name from apexclass where name = '"+e+"'").then(function(e){return e[0].Id}).then(function(e){return t.testId(e)})};