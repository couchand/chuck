<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="/_utils/script/jquery.js"></script>
<script src="/_utils/script/jquery.couch.js"></script>
<script src="d3.v3.js"></script>
<style>
svg text {
    fill: #333;
    font: 10pt sans-serif;
}
</style>
<script>

var width = 600, height = 300,
    margin = { top: 20, right: 20, bottom: 20, left: 70 };

var percentile = d3.scale.quantile()
    .range([0,1,2,3,4,5,6,7,8,9]);

var bucket = d3.layout.histogram()
    .bins([1, 2, 3, 4, 5, 6])
    .value(function(d) {
      return percentile(d.complexity);
    });

var grade = d3.scale.threshold()
    .domain([2, 3, 4, 5])
    .range(['A','B','C','D','F']);

var color = d3.scale.ordinal()
    .domain(['A','B','C','D','F'])
    .range(['#00aa00','#80cc00','#ffee00','#f77700','#ee0000']);

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

var focus = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var legend = svg.append("g")
    .attr("transform", "translate(650,30)");

d3.json("_view/class_details", function(viewdata) {
  var rows = viewdata["rows"], data = [];
  var complexities = [];

  rows.forEach(function(cls) {
    data.push( cls.value );
  });

  data.forEach(function(cls) {
    complexities.push( cls.complexity );
  });

  percentile.domain( complexities );

  var buckets = bucket(data);

  buckets.forEach(function(b) {
    console.log(b.x, b.y, b.dx);
  });

  var bar = svg.selectAll(".bar")
      .data(buckets)
    .enter().append("g")
      .attr("class", "bar")
      .attr("transform", function(d) {
        return "translate(" + 15*d.x + "," + (height - d.y) + ")";
      });

  bar.append("rect")
      .attr("x", 1)
      .attr("width", 14)
      .attr("height", function(d) { return d.y; })
      .attr("fill", function(d) { return color(grade(d.x)); });

  bar.append("text")
      .attr("dy", "0.75em")
      .attr("y", 6)
      .attr("x", 7)
      .attr("text-anchor", "middle")
      .text(function(d) { return grade(d.x); });

});

</script>
