<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="/_utils/script/jquery.js"></script>
<script src="/_utils/script/jquery.couch.js"></script>
<script src="d3.v3.js"></script>
<script>

function color(z) {
  return d3.rgb( 255-z, 72, z );
}

var clients = [];

var width = 800, height = 500,
    margin = { top: 10, right: 10, bottom: 20, left: 70 };

var x = d3.scale.linear().range([0, width]),
    y = d3.scale.linear().range([height, 0]),
    z = d3.scale.linear().range([2, 25]),
    w = d3.scale.category10();

var xAxis = d3.svg.axis().scale(x).orient("bottom"),
    yAxis = d3.svg.axis().scale(y).orient("left");

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

var focus = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var legend = svg.append("g")
    .attr("transform", "translate(650,30)");

d3.json("_view/client_details", function(viewdata) {
  var rows = viewdata["rows"], data = [], data2 = [];
  rows.forEach(function(d) {
    d.value.forEach(function(cls) {
      cls.client = d.key;
      if ( clients.indexOf( cls.client ) == -1 ) clients.push( cls.client );
      data.push(cls);
      if ( !!cls.error ) return;
      if ( !cls.complexity ) return;
      data2.push(cls);
    });
  });

  w.domain(clients);

  var offset = 0;
  clients.forEach(function(client) {
    var row = legend.append("g")
        .attr("transform","translate(0,"+offset+")");

    row.append("rect")
        .attr("width",20)
        .attr("height",20)
        .attr("style","fill: "+w(client));

    row.append("text")
        .attr("x",22)
        .attr("dy",15)
        .text(client);

    offset += 22;
  });

  focus.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  focus.append("g")
      .attr("class", "y axis")
      .call(yAxis);

  update(data2);
});

function update( data ) {
  x.domain(d3.extent(data.map(function(d) { return d.methods; })));
  y.domain(d3.extent(data.map(function(d) { return d.complexity; })));
  z.domain(d3.extent(data.map(function(d) { return d.lines; })));

  focus.selectAll("g.cls")
      .data(data)
    .enter().append("g")
      .attr("class", "cls")
      .attr("transform", function (d) {
        return "translate(" + x(d.methods) + "," + y(d.complexity) + ")";
      })
      .append("circle")
      .attr("r", function (d) {
        return z(d.lines);
      })
      .attr("style", function (d) {
        return "fill: " + w(d.client);
      });
}

</script>
