<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="/_utils/script/jquery.js"></script>
<script src="/_utils/script/jquery.couch.js"></script>
<script src="d3.v3.js"></script>
<style>
svg text {
    fill: #333;
    font: 10pt sans-serif;
}
</style>
<script>

var width = 100, height = 100,
    offset = { left: width / 2, top: height / 2 },
    radius = 40, thickness = 15,
    margin = { top: 20, right: 20, bottom: 20, left: 20 };

var percentile = d3.scale.quantile()
    .range([0,1,2,3,4,5,6,7,8,9]);

var evaluate = d3.scale.threshold()
    .domain([3, 6, 8, 9])
    .range([1, 2, 3, 4, 5]);

var grade = d3.scale.threshold()
    .domain([2, 3, 4, 5])
    .range(['A','B','C','D','F']);

var gradeNum = d3.scale.ordinal()
    .domain(['A','B','C','D','F'])
    .range([1, 2, 3, 4, 5]);

var color = d3.scale.ordinal()
    .domain(['A','B','C','D','F'])
    .range(['#00aa00','#80cc00','#ffee00','#f77700','#ee0000']);

var x = d3.scale.linear()
    .domain([0, 5])
    .range([0, width]);
var y = d3.scale.linear()
    .range([height, 0]);

var arc = d3.svg.arc()
    .outerRadius( radius )
    .innerRadius( radius - thickness );

var pie = d3.layout.pie()
    .sort(null)
    .value(function(d) { return d.count; });

var clientPos = d3.scale.ordinal()
    .range([
      { x: 0,       y: 0      },
      { x: width,   y: 0      },
      { x: width*2, y: 0      },
      { x: 0,       y: height },
      { x: width,   y: height },
      { x: width*2, y: height }
    ]);

var svg = d3.select("body").append("svg")
    .attr("width", 3*width + margin.left + margin.right)
    .attr("height", 2*height + margin.top + margin.bottom);

var focus = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.json("_view/class_details", function(viewdata) {
  var rows = viewdata["rows"], data = [], clients = {};
  var complexities = [], frequencies = [], byClient = [];

  rows.forEach(function(row) {
    data.push( row.value );
    complexities.push( row.value.complexity );
  });

  percentile.domain( complexities );

  data.forEach(function(cls) {
    if ( !clients[cls.client] ) {
      clients[cls.client] = {
        A: 0, B: 0, C: 0, D: 0, F: 0
      }
    }

    var classGrade = grade(evaluate(percentile( cls.complexity )));

    clients[cls.client][classGrade]++;
  });

  for ( var client in clients ) {
    thisClient = [];
    thisClient.name = client;
    for ( var classGrade in clients[client] ) {
      frequencies.push({
        client: client,
        grade: classGrade,
        count: clients[client][classGrade]
      });
      thisClient.push({
        grade: classGrade,
        count: clients[client][classGrade]
      });
    }
    byClient.push(thisClient);
  }

  y.domain([0, d3.max(frequencies, function(d) { return d.count; })]);

  var bar = focus.selectAll(".bar")
      .data(frequencies)
    .enter().append("g")
      .attr("class", "bar")
      .attr("title", function(d) { return d.client; })
      .attr("transform", function(d) {
        var xCoord = clientPos(d.client).x + x(gradeNum(d.grade) - 1);
        var yCoord = clientPos(d.client).y + y(d.count);
        return "translate(" + xCoord + "," + yCoord + ")";
      });

  bar.append("rect")
      .attr("x", 1)
      .attr("width", width/5 - 1)
      .attr("height", function(d) { return height - y(d.count); })
      .attr("fill", function(d) { return color(d.grade); });

  var clientCanvas = focus.selectAll(".client")
      .data(byClient)
    .enter().append("g")
      .attr("class","client")
      .attr("transform",function(d) {
        var p = clientPos(d.name);
        return "translate(" + (p.x+offset.left) + "," + (p.y+offset.top) + ")";
      });

  var slice = clientCanvas.selectAll(".arc")
      .data(pie)
    .enter().append("path")
      .attr("d", arc)
      .attr("class","arc")
      .attr("fill", function(d) { return color(d.data.grade); });

});

</script>
